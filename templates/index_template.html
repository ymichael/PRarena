<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PR Arena - AI Coding Agent Leaderboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <link rel="stylesheet" href="styles.css" />
    <meta http-equiv="refresh" content="3600" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Microsoft Clarity Analytics -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "s40u7bxxnn");
    </script>
  </head>
  <body>
    <div class="container">
      <header class="hero">
        <h1>PR Arena</h1>
        <p>Software engineering agents head to head</p>
      </header>

      <!-- Dynamic Leaderboard -->
      <section class="leaderboard">
        <div class="leaderboard-header">
          <h2>Leaderboard</h2>
          <div class="sort-controls">
            <div class="dropdown-container">
              <button class="sort-btn dropdown-btn" data-sort="success-rate" id="successRateBtn">
                Success Rate <span class="mode-indicator">(M/R)</span> <span class="dropdown-arrow">‚ñº</span>
              </button>
              <div class="dropdown-menu" id="successRateDropdown">
                <button class="dropdown-item active" data-rate-type="ready">Merged/Ready PRs</button>
                <button class="dropdown-item" data-rate-type="total">Merged/All PRs, including drafts</button>
              </div>
            </div>
            <button class="sort-btn active" data-sort="total-prs">Total PRs</button>
            <button class="sort-btn" data-sort="merged-prs">Merged PRs</button>
          </div>
        </div>

        <div class="agents-container" id="agentsContainer">
{% for agent in agents %}
          <div class="agent"
               data-success-rate="{{ stats[agent.key].rate }}"
               data-success-rate-ready="{{ stats[agent.key].ready_rate }}"
               data-success-rate-total="{{ stats[agent.key].total_rate }}"
               data-total-prs="{{ stats[agent.key].total }}"
               data-ready-prs="{{ stats[agent.key].nondraft }}"
               data-merged-prs="{{ stats[agent.key].merged }}"
               data-agent-name="{{ agent.long_name }}">
            <div class="agent-header">
              <div class="rank" data-rank="{{ loop.index }}">#{{ loop.index }}</div>
              <div class="agent-dot" style="background-color: {{ agent.color }}"></div>
              <div class="agent-info">
                <h3><a href="{{ agent.info_url }}" target="_blank">{{ agent.long_name }}</a></h3>
                <span class="agent-subtitle">
                  <span class="pr-count">{{ stats[agent.key].nondraft | comma }}</span>
                  <span class="pr-type">ready</span> /
                  <span class="pr-total">{{ stats[agent.key].total | comma }}</span>
                  <span class="pr-total-label">all PRs</span>
                </span>
              </div>
            </div>
            <div class="metrics">
              <div class="primary-metric">
                <span class="metric-value">
                  {{ stats[agent.key].rate | round(1) }}%
                </span>
                <span class="metric-label">Success Rate</span>
              </div>
              <div class="secondary-metrics">
                <div class="metric draft-metric">
                  <a href="{{ agent.draft_query_url }}" target="_blank">
                    <span class="metric-count">{{ (stats[agent.key].total - stats[agent.key].nondraft) | comma }}</span>
                    <span>draft</span>
                  </a>
                </div>
                <div class="metric">
                  <a href="{{ agent.ready_query_url }}" target="_blank">
                    <span class="metric-count">{{ stats[agent.key].nondraft | comma }}</span>
                    <span>ready</span>
                  </a>
                </div>
                <div class="metric">
                  <a href="{{ agent.merged_query_url }}" target="_blank">
                    <span class="metric-count">{{ stats[agent.key].merged | comma }}</span>
                    <span>merged</span>
                  </a>
                </div>
              </div>
            </div>
          <div class="progress-bar">
            <div
              class="progress"
              style="width: {{ stats[agent.key].rate }}%; background-color: {{ agent.color }}"
            ></div>
          </div>
        </div>
        {% endfor %}
      </section>

      <!-- Definitions section -->
      <section class="definitions">
        <div class="explanation-section">
          <button class="explanation-toggle" id="explanationToggle">
            <span class="toggle-text">IMPORTANT DEFINITIONS</span>
            <span class="toggle-arrow">‚ñº</span>
          </button>
          <div class="explanation-content" id="explanationContent">
            <p>Different AI coding agents follow different workflows when creating pull requests:</p>
            <ul>
              <li><strong>All PRs:</strong> Every pull request created by an agent, including DRAFT PRs.</li>
              <li><strong>Ready PRs:</strong> Non-draft pull requests that are ready for review and merging</li>
              <li><strong>Merged PRs:</strong> Pull requests that were successfully merged into the codebase</li>
            </ul>
            <p><strong>Key workflow differences:</strong> Some agents like <strong>Codex</strong> iterate privately and create ready PRs directly, resulting in very few drafts but high merge rates. Others like <strong>Copilot</strong> and <strong>Codegen</strong> create draft PRs first, encouraging public iteration before marking them ready for review.</p>
            <p>By default, we show success rates using <strong>Ready PRs only</strong> to fairly compare agents across different workflows. This focuses on each agent's ability to produce mergeable code, regardless of whether they iterate publicly (with drafts) or privately. Toggle to "Include draft PRs" to see the complete picture of all activity.</p>
          </div>
        </div>
      </section>

      <!-- Historic Chart -->
      <section class="chart">
        <h2>PR Volume & Success Rate</h2>
        <div class="chart-controls">
          <div class="control-row">
            <div class="control-section">
              <span class="control-label">AGENTS</span>
              <div class="toggle-buttons">
                {% for agent in agents %}
                <button
                  id="toggle{{ agent.key|title }}"
                  class="toggle-btn active"
                  data-agent="{{ agent.key }}"
                >
                  <span
                    class="toggle-icon"
                    style="background-color: {{ agent.color }}"
                  ></span
                  >{{ agent.long_name }}
                </button>
                {% endfor %}
              </div>
            </div>
            <div class="control-section">
              <span class="control-label">SUCCESS RATE</span>
              <div class="toggle-buttons">
                <button id="rateReady" class="rate-btn active" data-rate="ready">
                  <span class="rate-icon">‚óè</span>Ready PRs Only (M/R)
                </button>
                <button id="rateTotal" class="rate-btn" data-rate="total">
                  All PRs (M/A)
                </button>
              </div>
            </div>
            <div class="control-section">
              <span class="control-label">VIEW MODE</span>
              <div class="toggle-buttons">
                <button id="viewAll" class="view-btn active" data-view="all">
                  <span class="view-icon">‚óè</span>Complete View
                </button>
                <button id="viewBarsOnly" class="view-btn" data-view="bars">
                  Volume Only
                </button>
                <button id="viewLinesOnly" class="view-btn" data-view="lines">
                  Success Rate Only
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="prChart" width="800" height="400"></canvas>
        </div>
      </section>

      <!-- Simple Footer -->
      <footer class="footer">
        <p>
          Updated {{ timestamp }} ‚Ä¢
          <a href="https://github.com/aavetis/ai-pr-watcher" target="_blank">by aavetis</a>
        </p>
      </footer>
    </div>

    <script>
      // Chart instance
      let chartInstance = null;
      let currentRateType = 'ready'; // Track current success rate type
      let currentChartRateType = 'ready'; // Track current chart success rate type

      document.addEventListener("DOMContentLoaded", function () {
        initializeSorting();
        initializeDropdown();
        initializeExplanation();
        loadCharts();
        // Sort by total PRs on page load
        sortAgents("total-prs");
      });

      // Dynamic Sorting
      function initializeSorting() {
        const sortButtons = document.querySelectorAll(".sort-btn");
        sortButtons.forEach((btn) => {
          if (!btn.classList.contains('dropdown-btn')) {
            btn.addEventListener("click", () => {
              // Update active button
              sortButtons.forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");

              // Sort agents
              sortAgents(btn.dataset.sort);
            });
          }
        });
      }

      function initializeDropdown() {
        const dropdownBtn = document.getElementById('successRateBtn');
        const dropdown = document.getElementById('successRateDropdown');
        const dropdownItems = document.querySelectorAll('.dropdown-item');
        const arrow = dropdownBtn.querySelector('.dropdown-arrow');

        // Toggle dropdown
        dropdownBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isShowing = dropdown.classList.contains('show');
          dropdown.classList.toggle('show');

          // Rotate arrow
          if (dropdown.classList.contains('show')) {
            arrow.style.transform = 'rotate(180deg)';
          } else {
            arrow.style.transform = 'rotate(0deg)';
          }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          dropdown.classList.remove('show');
          arrow.style.transform = 'rotate(0deg)';
        });

        // Handle dropdown item selection
        dropdownItems.forEach(item => {
          item.addEventListener('click', (e) => {
            e.stopPropagation();

            // Update active item
            dropdownItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');

            // Update rate type
            currentRateType = item.dataset.rateType;

            // Update button text to show current mode
            const modeText = currentRateType === 'ready' ? '(M/R)' : '(M/A)';
            dropdownBtn.innerHTML = `Success Rate <span class="mode-indicator">${modeText}</span> <span class="dropdown-arrow">‚ñº</span>`;

            // Update all agents' data and resort
            updateAgentMetrics(currentRateType);
            sortAgents('success-rate');

            // Close dropdown
            dropdown.classList.remove('show');
            arrow.style.transform = 'rotate(0deg)';

            // Make sure success rate button is active
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            dropdownBtn.classList.add('active');
          });
        });
      }

      function initializeExplanation() {
        const toggle = document.getElementById('explanationToggle');
        const content = document.getElementById('explanationContent');
        const arrow = toggle.querySelector('.toggle-arrow');

        toggle.addEventListener('click', () => {
          const isExpanded = content.classList.contains('expanded');

          if (isExpanded) {
            content.classList.remove('expanded');
            toggle.classList.remove('expanded');
          } else {
            content.classList.add('expanded');
            toggle.classList.add('expanded');
          }
        });
      }

      function updateAgentMetrics(rateType) {
        const agents = document.querySelectorAll('.agent');

        agents.forEach(agent => {
          const rate = rateType === 'ready'
            ? parseFloat(agent.dataset.successRateReady)
            : parseFloat(agent.dataset.successRateTotal);

          // Update the data attribute for sorting
          agent.dataset.successRate = rate;

          // Update the primary metric display
          const metricValue = agent.querySelector('.metric-value');
          metricValue.textContent = rate.toFixed(1) + '%';

          // Update the progress bar
          const progressBar = agent.querySelector('.progress');
          progressBar.style.width = rate + '%';

          // Update subtitle to highlight the current mode
          const subtitle = agent.querySelector('.agent-subtitle');
          const prCount = subtitle.querySelector('.pr-count');
          const prType = subtitle.querySelector('.pr-type');

          if (rateType === 'ready') {
            prCount.textContent = parseInt(agent.dataset.readyPrs).toLocaleString();
            prType.textContent = 'ready';
            prType.style.fontWeight = '600';
            subtitle.querySelector('.pr-total-label').style.opacity = '0.6';
          } else {
            prCount.textContent = parseInt(agent.dataset.totalPrs).toLocaleString();
            prType.textContent = 'all';
            prType.style.fontWeight = '600';
            subtitle.querySelector('.pr-total-label').style.opacity = '1';
          }
        });
      }

      function sortAgents(criteria) {
        const container = document.getElementById("agentsContainer");
        const agents = Array.from(container.children);

        agents.sort((a, b) => {
          let valueA, valueB;

          switch (criteria) {
            case "success-rate":
              valueA = parseFloat(a.dataset.successRate);
              valueB = parseFloat(b.dataset.successRate);
              break;
            case "total-prs":
              valueA = parseInt(a.dataset.totalPrs);
              valueB = parseInt(b.dataset.totalPrs);
              break;
            case "merged-prs":
              valueA = parseInt(a.dataset.mergedPrs);
              valueB = parseInt(b.dataset.mergedPrs);
              break;
            default:
              return 0;
          }

          return valueB - valueA; // Descending order
        });

        // Update ranks and re-append in new order
        agents.forEach((agent, index) => {
          const rank = agent.querySelector(".rank");
          rank.textContent = `#${index + 1}`;
          rank.dataset.rank = index + 1;
          container.appendChild(agent);
        });

        // Add animation
        agents.forEach((agent, index) => {
          agent.style.animation = "none";
          setTimeout(() => {
            agent.style.animation = `fadeInUp 0.4s ease forwards`;
            agent.style.animationDelay = `${index * 0.1}s`;
          }, 10);
        });
      }

      // Chart Loading
      async function loadCharts() {
        try {
          console.log("Loading chart data...");
          const response = await fetch("chart-data.json");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Chart data loaded:", data);

          initializeChart(data);
        } catch (error) {
          console.error("Charts failed to load:", error);
          // Show error message in chart
          document.querySelector(".chart-container").innerHTML =
            '<p style="color: #ef4444; text-align: center; padding: 2rem;">Failed to load chart</p>';
        }
      }

      function initializeChart(chartData) {
        console.log("Initializing combined chart...");
        const ctx = document.getElementById("prChart").getContext("2d");

        chartInstance = new Chart(ctx, {
          type: "bar",
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: "point",
            },
            plugins: {
              title: {
                display: false,
              },
              legend: {
                display: true,
                position: "right",
                labels: {
                  usePointStyle: true,
                  pointStyle: "circle",
                  color: "#64748b",
                  font: {
                    family: "IBM Plex Mono",
                    size: 11,
                    weight: "500",
                  },
                  padding: 15,
                  boxWidth: 12,
                },
              },
              tooltip: {
                titleColor: "#1f2937",
                bodyColor: "#374151",
                backgroundColor: "rgba(255, 255, 255, 0.95)",
                borderColor: "#e5e7eb",
                borderWidth: 1,
                callbacks: {
                  title: function (context) {
                    return context[0].label;
                  },
                  label: function (context) {
                    const datasetLabel = context.dataset.label;
                    const value = context.parsed.y;

                    if (datasetLabel.includes("Success %")) {
                      return datasetLabel + ": " + value.toFixed(1) + "%";
                    } else {
                      return (
                        datasetLabel + ": " + value.toLocaleString() + " PRs"
                      );
                    }
                  },
                },
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Time",
                  color: "#475569",
                  font: {
                    family: "IBM Plex Mono",
                    size: 12,
                    weight: "500",
                  },
                },
                grid: { color: "#f1f5f9", lineWidth: 1 },
                ticks: {
                  color: "#475569",
                  font: { family: "IBM Plex Mono", size: 11 },
                  maxRotation: 45,
                  minRotation: 0
                },
              },
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: {
                  display: true,
                  text: "Number of PRs",
                  color: "#475569",
                  font: {
                    family: "IBM Plex Mono",
                    size: 12,
                    weight: "500",
                  },
                },
                grid: { color: "#f1f5f9", lineWidth: 1 },
                ticks: {
                  color: "#475569",
                  font: { family: "IBM Plex Mono", size: 11 },
                  callback: function(value) {
                    return value.toLocaleString();
                  }
                },
                beginAtZero: true,
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                title: {
                  display: true,
                  text: "Success Rate (%)",
                  color: "#475569",
                  font: {
                    family: "IBM Plex Mono",
                    size: 12,
                    weight: "500",
                  },
                },
                ticks: {
                  color: "#475569",
                  font: { family: "IBM Plex Mono", size: 11 },
                  callback: function (value) {
                    return value + "%";
                  },
                },
                beginAtZero: true,
                max: 100,
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });

        console.log("Chart initialized");

        // Set up toggle functionality
        setupToggleButtons();

        // Initialize chart with proper dataset visibility
        updateChartVisibility();
      }

      function updateChartVisibility() {
        if (!chartInstance) return;

        chartInstance.data.datasets.forEach((dataset) => {
          const isLine = dataset.type === "line";
          const isBar = dataset.type === "bar";
          const labelLower = dataset.label.toLowerCase();

          // Get the agent name from the dataset label
          const agentMatch = labelLower.match(/(copilot|codex|cursor|devin|codegen|terragon)/);
          const agent = agentMatch ? agentMatch[1] : null;

          // Check if agent is currently enabled
          const agentButton = document.querySelector(`.toggle-btn[data-agent="${agent}"]`);
          const agentEnabled = agentButton && agentButton.classList.contains("active");

          // Check current view mode
          const activeViewBtn = document.querySelector(".view-btn.active");
          const currentView = activeViewBtn ? activeViewBtn.dataset.view : "all";

          // For lines, check rate type
          const isCorrectRateType = isLine ?
            (currentChartRateType === 'ready' ? labelLower.includes('ready') : labelLower.includes('all')) :
            true;

          // Set visibility based on all conditions
          switch (currentView) {
            case "all":
              dataset.hidden = !agentEnabled || (isLine && !isCorrectRateType);
              break;
            case "bars":
              dataset.hidden = !agentEnabled || isLine;
              break;
            case "lines":
              dataset.hidden = !agentEnabled || isBar || (isLine && !isCorrectRateType);
              break;
          }
        });

        chartInstance.update();
      }

      function setupToggleButtons() {
        const toggleButtons = document.querySelectorAll(".toggle-btn");
        const viewButtons = document.querySelectorAll(".view-btn");
        const rateButtons = document.querySelectorAll(".rate-btn");

        // Agent toggle functionality
        toggleButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const agent = this.dataset.agent;

            // Toggle button state
            this.classList.toggle("active");

            // Update chart visibility
            updateChartVisibility();
          });
        });

        // Success rate type functionality
        rateButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const rateType = this.dataset.rate;

            // Update button states
            rateButtons.forEach((btn) => btn.classList.remove("active"));
            this.classList.add("active");

            // Update current rate type
            currentChartRateType = rateType;

            // Update chart visibility
            updateChartVisibility();
          });
        });

        // View mode functionality
        viewButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const view = this.dataset.view;

            // Update button states
            viewButtons.forEach((btn) => btn.classList.remove("active"));
            this.classList.add("active");

            // Update chart visibility
            updateChartVisibility();
          });
        });
      }
    </script>
  </body>
</html>
